<!DOCTYPE html>
<html>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="ISO-8859-1">
	<title>Vaccine Finder</title>
    <head>    
        <style>
            table {
              font-family: arial, sans-serif;
              border-collapse: collapse;
              width: 100%;
            }
            
            td, th {
              border: 1px solid #dddddd;
              text-align: left;
              padding: 8px;
              width: 10% !important
            }
            
            tr:nth-child(even) {
              background-color: #dddddd;
            }

            .searchBtnDiv{
                padding-top: 30px;
            }
            .regLink {
                padding-left: 60%;
            }
			#dateDiv{
				padding-top: 2%;
			}
			.searchBtn{
				  width: 50%;
				  background-color: #4CAF50; /* Green */
				  border: none;
				  color: white;
				  padding: 15px 32px;
				  text-align: center;
				  text-decoration: none;
				  display: inline-block;
				  font-size: 16px;
				  
			}
			.searchBtn:active{
				   background-color:red;
				}
			select {
				width:100%
			}
			.column {
	            padding: 5px;
            }
			
			@media only screen and (min-width: 600px) {
            /* Three image containers (use 25% for four, and 50% for two, etc) */
            .column {
            float: left;
            width: 15%;
            padding: 5px;
            }

            /* Clear floats after image containers */
            .row::after {
            content: "";
            clear: both;
            display: table;
            }
            .regLink {
                padding-left: 90%;
            }
			.searchBtn{
				  width: 10%;
				  background-color: #4CAF50; /* Green */
				  border: none;
				  color: white;
				  padding: 10px 30px;
				  text-align: center;
				  text-decoration: none;
				  display: inline-block;
				  font-size: 16px;
			}
			}
            </style>    
        <script>      
        
        navigator.serviceWorker.register('sw.js');

        document.addEventListener('DOMContentLoaded', function() {
		 if (!Notification) {
		  alert('Desktop notifications not available in your browser. Try Chromium.');
		  return;
		 }

		 if (Notification.permission !== 'granted')
		  Notification.requestPermission();
		});
		
        function askForApproval() {
            if(Notification.permission === "granted") {
                createNotification('Vaccine Alert', 'Your search based vaccine slot is available now', '');
            }
            else {
                Notification.requestPermission(permission => {
                    if(permission === 'granted') {
                        createNotification('Vaccine Alert', 'Your search based vaccine slot is available now', '');
                    }
                });
            }
        }
        
        function createNotification(title, text, icon) {
            const noti = new Notification(title, {
                body: text,
                icon
            });
        }
        var DEFAULT_MSG = "No Slots Free"; 		
        setInterval(searchSlot, 60000); //Search interval in milliseconds
        populateState();
		var today = new Date();
		
		function setCurrentDate(){			
			var dd = today.getDate();					
			dd = ("0" + dd).slice(-2);
			var mm = today.getMonth()+1; 
			mm = ("0" + mm).slice(-2);
			var yyyy = today.getFullYear();
			var currDate = yyyy+'-'+mm+'-'+dd;
			document.getElementById("searchDt").value=currDate;			
		}

        function populateState(){
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                        // Typical action to be performed when the document is ready:
                        var response = this.responseText;
                        var obj = JSON.parse(response);
                        var states = obj.states;
                        var msg = "<option value=\"\" disabled selected>Select</option>";
                        states.forEach((item) => {
                            msg=msg+"<option value=\""+item.state_id+"\">"+item.state_name+"</option>"
                        });
                        document.getElementById("statedrp").innerHTML = msg;
                        setCurrentDate();
                       
                    }else if(this.readyState == 4 && this.status != 200){
					document.getElementById("errorlbl").innerHTML = "<b style=\"color: red;\">Service Not Available<b>";
				}
                };
                
                xhttp.open("GET", "https://cdn-api.co-vin.in/api/v2/admin/location/states", true);

                xhttp.send();
        }

        function populateDistrict(district){
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                        // Typical action to be performed when the document is ready:
                        var response = this.responseText;
                        var obj = JSON.parse(response);
                        var districts = obj.districts;
                        var msg = "<option value=\"\" disabled selected>Select</option>";
                        districts.forEach((item) => {
                            msg=msg+"<option value=\""+item.district_id+"\">"+item.district_name+"</option>"
                        });
                        document.getElementById("districtdrp").innerHTML = msg;
                        
                       
                    }else if(this.readyState == 4 && this.status != 200){
					document.getElementById("errorlbl").innerHTML = "<b style=\"color: red;\">Service Not Available<b>";
				}
                };
                
                xhttp.open("GET", "https://cdn-api.co-vin.in/api/v2/admin/location/districts/"+district, true);

                xhttp.send();
        }
        

        function searchSlot(){     
        	document.getElementById("errorlbl").style="display:none;"
				var district_id ="";
				var ageGrp = "";
				var dose ="";
				var searchDate = "";
				var feeTyp = "";
				var vaccine = "";
				if(document.getElementById("searchDt")){
					searchDate = document.getElementById("searchDt").value;;
				}
				if(document.getElementById("hidDistrct")){
					district_id = document.getElementById("hidDistrct").value;
				}
					
				if(document.querySelector('input[name="ageGrp"]:checked')){
					ageGrp = document.querySelector('input[name="ageGrp"]:checked').value;  
				}
                
                if(document.querySelector('input[name="doseGrp"]:checked')){
					dose = document.querySelector('input[name="doseGrp"]:checked').value; 
				}                
                if(document.getElementById("hidFeeTyp")){
                	feeTyp = document.getElementById("hidFeeTyp").value;
				}
                if(document.getElementById("hidVaccine")){
                	vaccine = document.getElementById("hidVaccine").value;
				}
				
				if(district_id === "" || ageGrp === "" || dose === "" || searchDate === ""){
					document.getElementById("errorlbl").style="display:block;"
					document.getElementById("errorlbl").innerHTML = "<b style=\"color: red;\">Please select required fields to search<b>";
					return;
				}
				var alertCount = 0;
                var xhttp = [];
				
				
				for (var i=0; i<7; i++) {
				  (function(i){ 	
					var day = new Date(searchDate);
					var nextDay = new Date(searchDate);
					nextDay.setDate(day.getDate() + i);					
					var dd = nextDay.getDate();
					dd = ("0" + dd).slice(-2);
                    var mm = nextDay.getMonth()+1; 
					mm = ("0" + mm).slice(-2);
                    var yyyy = nextDay.getFullYear();

					var currDate = dd+'-'+mm+'-'+yyyy;                

					xhttp[i] = new XMLHttpRequest();
					xhttp[i].onreadystatechange = function() {
					if (this.readyState == 4 && this.status == 200) {
							// Typical action to be performed when the document is ready:
							var response = this.responseText;
							var msg = "";
							if(feeTyp == "ALL" && vaccine == "ALL"){
								var msg = parseJsonAll(response,currDate,ageGrp,dose);
							}else{
								 msg = parseJson(response,currDate,ageGrp,dose,feeTyp,vaccine);
							}
							
							if (msg != DEFAULT_MSG){
								document.getElementById("day"+i).innerHTML = msg;
								if(alertCount <0){
									askForApproval();
									alertCount++;
								}
																
							}else{
								document.getElementById("day"+i).innerHTML = "<b>"+currDate+"</b> - "+msg;
							}
							document.getElementById("date").innerHTML = "Date:"+new Date();
						   
						}else if(this.readyState == 4 && this.status != 200){
						document.getElementById("errorlbl").innerHTML = "<b style=\"color: red;\">Service Not Available<b>";
					}
					};
					
					xhttp[i].open("GET", "https://cdn-api.co-vin.in/api/v2/appointment/sessions/public/calendarByDistrict?district_id="+district_id+"&date="+currDate, true);

					xhttp[i].send();
				})(i);
				}
               
            } 
        
        function parseJsonAll(response,currDate,ageGrp,dose){
            var obj = JSON.parse(response);
            var centers = obj.centers;
            var msg = "";
            
            for(var i=0; i< centers.length; i++){
                //if(centers[i].fee_type == feeTyp){
                    var sessions = centers[i].sessions;
                    for( var j=0; j< sessions.length; j++){
                        if(dose === "D1"){
                            if(sessions[j].date === currDate && sessions[j].min_age_limit == ageGrp && sessions[j].available_capacity_dose1 > 0
                            		 ){
                                msg =msg+"<p>"+ "<b>Date-"+sessions[j].date+"</b><br>"+"<table><tr><td>Center- "+centers[i].name+"</td>"+
                                    "<td>Avail-"+sessions[j].available_capacity_dose1+"</td>"+
                                    "<td>FeeType-"+centers[i].fee_type+"</td>"+
                                    "<td>District-"+centers[i].district_name+"</td>"+
									"<td>PinCode-"+centers[i].pincode+"</td>"+
                                    "<td>AgeLimit-"+sessions[j].min_age_limit+"</td>"+
                                    "<td>Vaccine-"+sessions[j].vaccine+"</td>"+"</tr></table>"+
                                    "</p>";
                                
                            }
                        }else{
                            if(sessions[j].date === currDate && sessions[j].min_age_limit == ageGrp && sessions[j].available_capacity_dose2 > 0
                            		){
                                msg =msg+"<p>"+ "<b>Date-"+sessions[j].date+"</b><br>"+"<table><tr><td>Center- "+centers[i].name+"</td>"+
                                    "<td>Avail-"+sessions[j].available_capacity_dose2+"</td>"+
                                    "<td>FeeType-"+centers[i].fee_type+"</td>"+
                                    "<td>District-"+centers[i].district_name+"</td>"+
									"<td>PinCode-"+centers[i].pincode+"</td>"+
                                    "<td>AgeLimit-"+sessions[j].min_age_limit+"</td>"+
                                    "<td>Vaccine-"+sessions[j].vaccine+"</td>"+"</tr></table>"+
                                    "</p>";
                                
                            }
                        }
                    }
                    
                //}
            }
            
            if(msg== ""){
                return DEFAULT_MSG;
            }else{
                return msg;
            }
        }
  
        function parseJson(response,currDate,ageGrp,dose,feeTyp,vaccine){
            var obj = JSON.parse(response);
            var centers = obj.centers;
            var msg = "";
            if(feeTyp != "ALL" && vaccine != "ALL"){
	            for(var i=0; i< centers.length; i++){
	                if(centers[i].fee_type == feeTyp){
	                    var sessions = centers[i].sessions;
	                    for( var j=0; j< sessions.length; j++){
	                        if(dose === "D1"){
	                            if(sessions[j].date === currDate && sessions[j].min_age_limit == ageGrp && sessions[j].available_capacity_dose1 > 0
	                            		 && sessions[j].vaccine == vaccine){
	                                msg =msg+"<p>"+ "<b>Date-"+sessions[j].date+"</b><br>"+"<table><tr><td>Center- "+centers[i].name+"</td>"+
	                                    "<td>Avail-"+sessions[j].available_capacity_dose1+"</td>"+
	                                    "<td>FeeType-"+centers[i].fee_type+"</td>"+
	                                    "<td>District-"+centers[i].district_name+"</td>"+
										"<td>PinCode-"+centers[i].pincode+"</td>"+
	                                    "<td>AgeLimit-"+sessions[j].min_age_limit+"</td>"+
	                                    "<td>Vaccine-"+sessions[j].vaccine+"</td>"+"</tr></table>"+
	                                    "</p>";
	                                
	                            }
	                        }else{
	                            if(sessions[j].date === currDate && sessions[j].min_age_limit == ageGrp && sessions[j].available_capacity_dose2 > 0
	                            		&& sessions[j].vaccine == vaccine){
	                                msg =msg+"<p>"+ "<b>Date-"+sessions[j].date+"</b><br>"+"<table><tr><td>Center- "+centers[i].name+"</td>"+
	                                    "<td>Avail-"+sessions[j].available_capacity_dose2+"</td>"+
	                                    "<td>FeeType-"+centers[i].fee_type+"</td>"+
	                                    "<td>District-"+centers[i].district_name+"</td>"+
										"<td>PinCode-"+centers[i].pincode+"</td>"+
	                                    "<td>AgeLimit-"+sessions[j].min_age_limit+"</td>"+
	                                    "<td>Vaccine-"+sessions[j].vaccine+"</td>"+"</tr></table>"+
	                                    "</p>";
	                                
	                            }
	                        }
	                    }
	                    
	                }
	            }
            }else if (feeTyp === "ALL" && vaccine != "ALL"){
            	for(var i=0; i< centers.length; i++){
	                //if(centers[i].fee_type == 'Paid'){
	                    var sessions = centers[i].sessions;
	                    for( var j=0; j< sessions.length; j++){
	                        if(dose === "D1"){
	                            if(sessions[j].date === currDate && sessions[j].min_age_limit == ageGrp && sessions[j].available_capacity_dose1 > 0
	                            		&& sessions[j].vaccine == vaccine){
	                                msg =msg+"<p>"+ "<b>Date-"+sessions[j].date+"</b><br>"+"<table><tr><td>Center- "+centers[i].name+"</td>"+
	                                    "<td>Avail-"+sessions[j].available_capacity_dose1+"</td>"+
	                                    "<td>FeeType-"+centers[i].fee_type+"</td>"+
	                                    "<td>District-"+centers[i].district_name+"</td>"+
										"<td>PinCode-"+centers[i].pincode+"</td>"+
	                                    "<td>AgeLimit-"+sessions[j].min_age_limit+"</td>"+
	                                    "<td>Vaccine-"+sessions[j].vaccine+"</td>"+"</tr></table>"+
	                                    "</p>";
	                                
	                            }
	                        }else{
	                            if(sessions[j].date === currDate && sessions[j].min_age_limit == ageGrp && sessions[j].available_capacity_dose2 > 0
	                            		&& sessions[j].vaccine == vaccine){
	                                msg =msg+"<p>"+ "<b>Date-"+sessions[j].date+"</b><br>"+"<table><tr><td>Center- "+centers[i].name+"</td>"+
	                                    "<td>Avail-"+sessions[j].available_capacity_dose2+"</td>"+
	                                    "<td>FeeType-"+centers[i].fee_type+"</td>"+
	                                    "<td>District-"+centers[i].district_name+"</td>"+
										"<td>PinCode-"+centers[i].pincode+"</td>"+
	                                    "<td>AgeLimit-"+sessions[j].min_age_limit+"</td>"+
	                                    "<td>Vaccine-"+sessions[j].vaccine+"</td>"+"</tr></table>"+
	                                    "</p>";
	                                
	                            }
	                        }
	                    }
	                    
	                //}
	            }
            }else if (feeTyp != "ALL" && vaccine === "ALL"){
            	for(var i=0; i< centers.length; i++){
	                if(centers[i].fee_type == feeTyp){
	                    var sessions = centers[i].sessions;
	                    for( var j=0; j< sessions.length; j++){
	                        if(dose === "D1"){
	                            if(sessions[j].date === currDate && sessions[j].min_age_limit == ageGrp && sessions[j].available_capacity_dose1 > 0
	                            		){
	                                msg =msg+"<p>"+ "<b>Date-"+sessions[j].date+"</b><br>"+"<table><tr><td>Center- "+centers[i].name+"</td>"+
	                                    "<td>Avail-"+sessions[j].available_capacity_dose1+"</td>"+
	                                    "<td>FeeType-"+centers[i].fee_type+"</td>"+
	                                    "<td>District-"+centers[i].district_name+"</td>"+
										"<td>PinCode-"+centers[i].pincode+"</td>"+
	                                    "<td>AgeLimit-"+sessions[j].min_age_limit+"</td>"+
	                                    "<td>Vaccine-"+sessions[j].vaccine+"</td>"+"</tr></table>"+
	                                    "</p>";
	                                
	                            }
	                        }else{
	                            if(sessions[j].date === currDate && sessions[j].min_age_limit == ageGrp && sessions[j].available_capacity_dose2 > 0
	                            		){
	                                msg =msg+"<p>"+ "<b>Date-"+sessions[j].date+"</b><br>"+"<table><tr><td>Center- "+centers[i].name+"</td>"+
	                                    "<td>Avail-"+sessions[j].available_capacity_dose2+"</td>"+
	                                    "<td>FeeType-"+centers[i].fee_type+"</td>"+
	                                    "<td>District-"+centers[i].district_name+"</td>"+
										"<td>PinCode-"+centers[i].pincode+"</td>"+
	                                    "<td>AgeLimit-"+sessions[j].min_age_limit+"</td>"+
	                                    "<td>Vaccine-"+sessions[j].vaccine+"</td>"+"</tr></table>"+
	                                    "</p>";
	                                
	                            }
	                        }
	                    }
	                    
	                }
	            }
            }
            if(msg== ""){
                return DEFAULT_MSG;
            }else{
                return msg;
            }
        }
function changeDistrict(value){    
    document.getElementById("hidDistrct").value=value;    
}
function changeVaccine(value){    
    document.getElementById("hidVaccine").value=value;    
}
function changeFeeType(value){    
    document.getElementById("hidFeeTyp").value=value;    
}
        </script>
    </head>
    <body>
        <h1>Vaccine Slot Availability</h1>
        <div class="row">
            <div id="selectDrpDiv" class="column">
                <label>Select State:</label>
                <select name="state" id="statedrp" onChange="populateDistrict(this.value);">      
                <option value="" disabled selected>Select</option>              
                </select>
            </div>
            <div id="selectDrpDiv" class="column">
                <label>Select District:</label>
                <select name="district" id="districtdrp" onChange="changeDistrict(this.value);">   
                <option value="" disabled selected>Select</option>                 
                </select>
            </div>
            <div id="selectDrpDiv" class="column">
                <label>Select Vaccine:</label>
                <select name="vaccineSel" id="vaccineSel" onChange="changeVaccine(this.value);">  
                <option value="ALL" selected>ALL</option>
                <option value="COVISHIELD">COVISHIELD</option>               
                <option value="COVAXIN">COVAXIN</option>
                </select>
            </div>
            <div id="selectDrpDiv" class="column">
                <label>Select Fee Type:</label>
                <select name="feeTypSel" id="feeTypSel" onChange="changeFeeType(this.value);">  
                <option value="ALL" selected>ALL</option>
                <option value="Paid">Paid</option>               
                <option value="Free">Free</option>
                </select>
            </div>
            </div>
            <div class="row">
            <div class="column">
            <fieldset>
                <legend>Age Group</legend>
            <div id="ageGrpDiv">
                <input type="radio" id="18" name="ageGrp" value="18">
                <label for="18">18+</label>
                <input type="radio" id="40" name="ageGrp" value="40">
                <label for="40">40+</label>
                <input type="radio" id="45" name="ageGrp" value="45">
                <label for="45">45+</label>
            </div>
           </fieldset>
            </div>
            <div class="column">
                <fieldset>
                <legend>Dose</legend>
                <div id="doseGrpDiv" >
                    <input type="radio" id="D1" name="doseGrp" value="D1">
                    <label for="D1">Dose1</label>
                    <input type="radio" id="D2" name="doseGrp" value="D2">
                    <label for="D2">Dose2</label>
                </div>
                </fieldset>
            </div>
			<div class="column" id="dateDiv">
				 <label for="searchDt">Date:</label>
				 <input type="date" id="searchDt" name="searchDt"> 
			</div>
            <div class="searchBtnDiv" ><input type="button" class="searchBtn" onclick="searchSlot()" value="Search"></div>
            
        </div>
        
        <div>
            <input type="hidden" id="hidDistrct" value=""/>
            <input type="hidden" id="hidVaccine" value="ALL"/>
            <input type="hidden" id="hidFeeTyp" value="ALL"/>
        </div>
        
        <div>
            <p id="day0"></p>
			<p id="day1"></p>
			<p id="day2"></p>
			<p id="day3"></p>
			<p id="day4"></p>
			<p id="day5"></p>
			<p id="day6"></p>
			<p id="day7"></p>
			<p id="errorlbl"></p>
        </div>
<br>
        <p id="date"></p>
        <div class="footer">
            <div class="row">
                <div class="col-md-12">
                    <strong>Disclaimer:</strong> This web app uses CoWin open API to find slots. Please click here to
                   <b><a href="https://selfregistration.cowin.gov.in/" target="_blank">Register/Book Slot</a></b><br/>
                </div>
            </div>
        </div>
    </body>
</html>
