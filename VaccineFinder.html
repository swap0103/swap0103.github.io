<html>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <head>    
        <style>
            table {
              font-family: arial, sans-serif;
              border-collapse: collapse;
              width: 100%;
            }
            
            td, th {
              border: 1px solid #dddddd;
              text-align: left;
              padding: 8px;
              width: 10% !important
            }
            
            tr:nth-child(even) {
              background-color: #dddddd;
            }
			
			@media only screen and (min-width: 600px) {
            /* Three image containers (use 25% for four, and 50% for two, etc) */
            .column {
            float: left;
            width: 15%;
            padding: 5px;
            }

            /* Clear floats after image containers */
            .row::after {
            content: "";
            clear: both;
            display: table;
            }
			}
            </style>    
        <script>               
        var DEFAULT_MSG = "No Slots Free"; 
        setInterval(searchSlot, 60000); //Search interval in milliseconds
        populateState();

        function populateState(){
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                        // Typical action to be performed when the document is ready:
                        var response = this.responseText;
                        var obj = JSON.parse(response);
                        var states = obj.states;
                        var msg = "<option value=\"\" disabled selected>Select</option>";
                        states.forEach((item) => {
                            msg=msg+"<option value=\""+item.state_id+"\">"+item.state_name+"</option>"
                        });
                        document.getElementById("statedrp").innerHTML = msg;
                        
                       
                    }else if(this.readyState == 4 && this.status != 200){
					document.getElementById("errorlbl").innerHTML = "<b style=\"color: red;\">Service Not Available<b>";
				}
                };
                
                xhttp.open("GET", "https://cdn-api.co-vin.in/api/v2/admin/location/states", true);

                xhttp.send();
        }

        function populateDistrict(district){
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                        // Typical action to be performed when the document is ready:
                        var response = this.responseText;
                        var obj = JSON.parse(response);
                        var districts = obj.districts;
                        var msg = "<option value=\"\" disabled selected>Select</option>";
                        districts.forEach((item) => {
                            msg=msg+"<option value=\""+item.district_id+"\">"+item.district_name+"</option>"
                        });
                        document.getElementById("districtdrp").innerHTML = msg;
                        
                       
                    }
                };
                
                xhttp.open("GET", "https://cdn-api.co-vin.in/api/v2/admin/location/districts/"+district, true);

                xhttp.send();
        }
        

        function searchSlot(){         
				var district_id ="";
				var ageGrp = "";
				var dose ="";
				
				if(document.getElementById("hidDistrct")){
					district_id = document.getElementById("hidDistrct").value;
				}
					
				if(document.querySelector('input[name="ageGrp"]:checked')){
					ageGrp = document.querySelector('input[name="ageGrp"]:checked').value;  
				}
                
                if(document.querySelector('input[name="doseGrp"]:checked')){
					dose = document.querySelector('input[name="doseGrp"]:checked').value; 
				}
				
				if(district_id === "" || ageGrp === "" || dose === ""){
					return;
				}
                
                var today = new Date();
                var dd = today.getDate();

                var mm = today.getMonth()+1; 
                var yyyy = today.getFullYear();

                var currDate = dd+'-'+mm+'-'+yyyy;                

                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                        // Typical action to be performed when the document is ready:
                        var response = this.responseText;
                        var msg = parseJson(response,currDate,ageGrp,dose);
                        if (msg != DEFAULT_MSG){
                            alert("Slot Available now");
                        }
                        document.getElementById("day").innerHTML = msg;
                        document.getElementById("date").innerHTML = "Date:"+today;
                       
                    }
                };
                
                xhttp.open("GET", "https://cdn-api.co-vin.in/api/v2/appointment/sessions/public/calendarByDistrict?district_id="+district_id+"&date="+currDate, true);

                xhttp.send();
               
            }     
  
        function parseJson(response,currDate,ageGrp,dose){
            var obj = JSON.parse(response);
            var centers = obj.centers;
            var msg = "";
            for(var i=0; i< centers.length; i++){
                //if(centers[i].fee_type == 'Paid'){
                    var sessions = centers[i].sessions;
                    for( var j=0; j< sessions.length; j++){
                        if(dose === "D1"){
                            if(sessions[j].min_age_limit == ageGrp && sessions[j].available_capacity_dose1 > 0){
                                msg =msg+"<p>"+ "<b>Date-"+sessions[j].date+"</b><br>"+"<table><tr><td>Center- "+centers[i].name+"</td>"+
                                    "<td>Avail-"+sessions[j].available_capacity_dose1+"</td>"+
                                    "<td>FeeType-"+centers[i].fee_type+"</td>"+
                                    "<td>District-"+centers[i].district_name+"</td>"+
									"<td>PinCode-"+centers[i].pincode+"</td>"+
                                    "<td>AgeLimit-"+sessions[j].min_age_limit+"</td>"+
                                    "<td>Vaccine-"+sessions[j].vaccine+"</td>"+"</tr></table>"+
                                    "</p>";
                                
                            }
                        }else{
                            if(sessions[j].min_age_limit == ageGrp && sessions[j].available_capacity_dose2 > 0){
                                msg =msg+"<p>"+ "<b>Date-"+sessions[j].date+"</b><br>"+"<table><tr><td>Center- "+centers[i].name+"</td>"+
                                    "<td>Avail-"+sessions[j].available_capacity_dose2+"</td>"+
                                    "<td>FeeType-"+centers[i].fee_type+"</td>"+
                                    "<td>District-"+centers[i].district_name+"</td>"+
									"<td>PinCode-"+centers[i].pincode+"</td>"+
                                    "<td>AgeLimit-"+sessions[j].min_age_limit+"</td>"+
                                    "<td>Vaccine-"+sessions[j].vaccine+"</td>"+"</tr></table>"+
                                    "</p>";
                                
                            }
                        }
                    }
                    
               // }
            }
            if(msg== ""){
                return DEFAULT_MSG;
            }else{
                return msg;
            }
        }
function changeDistrict(value){
    
    document.getElementById("hidDistrct").value=value;
    
}
        </script>
    </head>
    <body>
        <h1>Vaccine Availability</h1>
        <div class="row">
            <div id="selectDrpDiv" class="column">
                <label>Select State:</label>
                <select name="state" id="statedrp" onChange="populateDistrict(this.value);">                    
                </select>
            </div>
            <div id="selectDrpDiv" class="column">
                <label>Select District:</label>
                <select name="district" id="districtdrp" onChange="changeDistrict(this.value);">                    
                </select>
            </div>
            <div class="column">
            <fieldset>
                <legend>Age Group</legend>
            <div id="ageGrpDiv">
                <input type="radio" id="18" name="ageGrp" value="18">
                <label for="18">18+</label><br>
                <input type="radio" id="45" name="ageGrp" value="45">
                <label for="45">45+</label>
            </div>
           </fieldset>
            </div>
            <div class="column">
           <fieldset>
            <legend>Dose</legend>
            <div id="doseGrpDiv" >
                <input type="radio" id="D1" name="doseGrp" value="D1">
                <label for="D1">Dose1</label><br>
                <input type="radio" id="D2" name="doseGrp" value="D2">
                <label for="D2">Dose2</label>
            </div>
            </fieldset>
        </div>
            <input type="button" onclick="searchSlot()" value="Search">
        </div>
        
        <div>
            <input type="hidden" id="hidDistrct" value=""/>
        </div>
        
        <div>
            <p id="day"></p>
			<p id="errorlbl"></p>
        </div>
<br>
        <p id="date"></p>
    </body>
</html>